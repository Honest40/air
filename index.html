<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üî• Pa Mwera Social</title>
  <style>
    /* Reset & base */
    body, html {
      margin: 0; padding: 0; font-family: Arial, sans-serif; background: #f0f2f5; color: #333;
    }
    a { color: #1877f2; cursor: pointer; text-decoration: none;}
    a:hover { text-decoration: underline; }
    button { cursor: pointer; }
    input, textarea {
      padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; width: 100%;
      box-sizing: border-box; margin: 5px 0;
    }
    img { max-width: 100%; height: auto; border-radius: 5px; }
    video { max-width: 100%; border-radius: 5px; }

    /* Layout */
    #app {
      max-width: 900px;
      margin: 0 auto;
      padding: 10px;
    }
    header {
      background: #c70000;
      color: white;
      padding: 12px;
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      user-select: none;
    }

    /* Auth forms */
    #auth-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px #ccc;
      max-width: 400px;
      margin: 30px auto;
    }
    #auth-section h2 {
      color: #c70000;
      margin-bottom: 15px;
      text-align: center;
    }
    #auth-message {
      margin: 10px 0;
      font-weight: 600;
    }

    /* Profile setup */
    #profile-setup {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px #ccc;
      max-width: 400px;
      margin: 20px auto;
    }

    /* Main app UI */
    #main-app {
      display: none;
    }
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    #search-input {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 200px;
    }
    #logout-btn {
      background: #c70000;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      font-weight: bold;
      transition: background 0.3s;
    }
    #logout-btn:hover {
      background: #a50000;
    }

    /* User info */
    #user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      background: white;
      padding: 10px 15px;
      border-radius: 10px;
      box-shadow: 0 0 6px #ccc;
    }
    #user-info img {
      width: 50px; height: 50px; border-radius: 50%;
      object-fit: cover;
      border: 2px solid #c70000;
    }
    #user-info span {
      font-weight: bold;
      font-size: 18px;
    }

    /* Post creation */
    #post-creator {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 0 8px #ccc;
      margin-bottom: 25px;
    }
    #post-text {
      width: 100%;
      min-height: 70px;
      resize: vertical;
    }
    #media-preview {
      margin-top: 10px;
      max-height: 200px;
      overflow: hidden;
    }
    #media-preview img, #media-preview video {
      max-height: 200px;
      border-radius: 10px;
    }
    #post-actions {
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    #post-actions input[type=file] {
      display: none;
    }
    #add-image-btn, #add-video-btn {
      background: #c70000;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      transition: background 0.3s;
    }
    #add-image-btn:hover, #add-video-btn:hover {
      background: #a50000;
    }
    #submit-post-btn {
      background: #1877f2;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      font-weight: bold;
      margin-left: auto;
      transition: background 0.3s;
    }
    #submit-post-btn:hover {
      background: #155db2;
    }

    /* Posts feed */
    #posts-feed {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 50px;
    }
    .post {
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 8px #ccc;
      padding: 15px;
    }
    .post-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .post-header img {
      width: 45px; height: 45px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #c70000;
    }
    .post-header .username {
      font-weight: bold;
      font-size: 16px;
    }
    .post-content {
      margin-bottom: 10px;
      white-space: pre-wrap;
    }
    .post-media img, .post-media video {
      width: 100%;
      max-height: 350px;
      border-radius: 10px;
      margin-top: 10px;
      object-fit: contain;
    }
    .post-actions {
      display: flex;
      gap: 15px;
      margin-top: 10px;
      font-weight: bold;
      user-select: none;
    }
    .post-actions span {
      cursor: pointer;
      color: #555;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .post-actions span:hover {
      color: #c70000;
    }
    .liked {
      color: #c70000 !important;
    }

    /* Comments */
    .comments {
      margin-top: 10px;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    .comment {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 8px;
    }
    .comment img {
      width: 30px; height: 30px;
      border-radius: 50%;
      object-fit: cover;
      border: 1.5px solid #c70000;
    }
    .comment-content {
      background: #f0f2f5;
      padding: 7px 12px;
      border-radius: 15px;
      max-width: 80%;
      font-size: 14px;
      word-wrap: break-word;
    }
    .comment-username {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 13px;
    }

    /* Comment form */
    .comment-form {
      display: flex;
      margin-top: 10px;
      gap: 10px;
    }
    .comment-input {
      flex-grow: 1;
      padding: 8px;
      border-radius: 20px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .comment-submit-btn {
      background: #c70000;
      border: none;
      padding: 8px 15px;
      color: white;
      border-radius: 20px;
      font-weight: bold;
      transition: background 0.3s;
    }
    .comment-submit-btn:hover {
      background: #a50000;
    }

    /* Search users list */
    #user-search-results {
      background: white;
      max-height: 200px;
      overflow-y: auto;
      border-radius: 10px;
      box-shadow: 0 0 8px #ccc;
      margin-top: 5px;
      padding: 10px;
    }
    .search-user {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
    }
    .search-user:hover {
      background: #f0f2f5;
    }
    .search-user img {
      width: 35px; height: 35px;
      border-radius: 50%;
      object-fit: cover;
      border: 1.5px solid #c70000;
    }
  </style>
</head>
<body>
  <div id="app">
    <header>üî• Pa Mwera</header>

    <!-- Auth Section -->
    <div id="auth-section">
      <h2>Login or Signup</h2>

      <div id="login-form">
        <input type="email" id="login-email" placeholder="Email" />
        <input type="password" id="login-password" placeholder="Password" />
        <button id="login-btn">Login</button>
        <p>Don't have an account? <a id="show-signup">Sign up here</a></p>
        <p id="auth-message"></p>
      </div>

      <div id="signup-form" style="display:none;">
        <input type="text" id="signup-name" placeholder="Full Name" />
        <input type="email" id="signup-email" placeholder="Email" />
        <input type="password" id="signup-password" placeholder="Password (min 6 chars)" />
        <button id="signup-btn">Sign Up</button>
        <p>Already have an account? <a id="show-login">Login here</a></p>
        <p id="auth-message-signup"></p>
      </div>
    </div>

    <!-- Profile Setup (set profile pic and name) -->
    <div id="profile-setup" style="display:none;">
      <h2>Set up your profile</h2>
      <input type="text" id="profile-name" placeholder="Enter your display name" />
      <label for="profile-pic">Upload Profile Picture:</label>
      <input type="file" id="profile-pic" accept="image/*" />
      <button id="save-profile-btn">Save Profile</button>
      <p id="profile-msg"></p>
    </div>

    <!-- Main App -->
    <div id="main-app" style="display:none;">
      <div id="top-bar">
        <input type="text" id="search-input" placeholder="Search users by name..." />
        <button id="logout-btn">Logout</button>
      </div>

      <div id="user-search-results"></div>

      <div id="user-info">
        <img id="user-profile-pic" src="" alt="Profile Picture" />
        <span id="user-name-display"></span>
      </div>

      <div id="post-creator">
        <textarea id="post-text" placeholder="What's on your mind?"></textarea>
        <div id="media-preview"></div>
        <div id="post-actions">
          <label for="post-image" id="add-image-btn">Add Image</label>
          <input type="file" id="post-image" accept="image/*" />
          <label for="post-video" id="add-video-btn">Add Video</label>
          <input type="file" id="post-video" accept="video/*" />
          <button id="submit-post-btn">Post</button>
        </div>
      </div>

      <div id="posts-feed"></div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      sendEmailVerification,
      onAuthStateChanged,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      setDoc,
      getDoc,
      getDocs,
      query,
      orderBy,
      onSnapshot,
      updateDoc,
      arrayUnion,
      where,
      serverTimestamp,
      increment
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC92g51j4qHlLgvf1GBHJfR58BlJ5rg7JQ",
      authDomain: "pa-mwera-social.firebaseapp.com",
      projectId: "pa-mwera-social",
      storageBucket: "pa-mwera-social.appspot.com",
      messagingSenderId: "255473977095",
      appId: "1:255473977095:web:ef6afedb928070f60027a2"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM Elements
    const authSection = document.getElementById("auth-section");
    const loginForm = document.getElementById("login-form");
    const signupForm = document.getElementById("signup-form");
    const authMessage = document.getElementById("auth-message");
    const authMessageSignup = document.getElementById("auth-message-signup");
    const showSignupLink = document.getElementById("show-signup");
    const showLoginLink = document.getElementById("show-login");

    const profileSetup = document.getElementById("profile-setup");
    const profileNameInput = document.getElementById("profile-name");
    const profilePicInput = document.getElementById("profile-pic");
    const saveProfileBtn = document.getElementById("save-profile-btn");
    const profileMsg = document.getElementById("profile-msg");

    const mainApp = document.getElementById("main-app");
    const logoutBtn = document.getElementById("logout-btn");

    const userNameDisplay = document.getElementById("user-name-display");
    const userProfilePic = document.getElementById("user-profile-pic");

    const postText = document.getElementById("post-text");
    const postImageInput = document.getElementById("post-image");
    const postVideoInput = document.getElementById("post-video");
    const mediaPreview = document.getElementById("media-preview");
    const submitPostBtn = document.getElementById("submit-post-btn");

    const postsFeed = document.getElementById("posts-feed");

    const searchInput = document.getElementById("search-input");
    const userSearchResults = document.getElementById("user-search-results");

    let currentUser = null;
    let currentUserData = null;
    let currentPostMediaFile = null;

    // Show signup form
    showSignupLink.onclick = () => {
      loginForm.style.display = "none";
      signupForm.style.display = "block";
      authMessage.textContent = "";
      authMessageSignup.textContent = "";
    };

    // Show login form
    showLoginLink.onclick = () => {
      signupForm.style.display = "none";
      loginForm.style.display = "block";
      authMessage.textContent = "";
      authMessageSignup.textContent = "";
    };

    // Sign up user
    document.getElementById("signup-btn").onclick = async () => {
      const name = document.getElementById("signup-name").value.trim();
      const email = document.getElementById("signup-email").value.trim();
      const password = document.getElementById("signup-password").value.trim();

      authMessageSignup.style.color = "red";
      if (!name) {
        authMessageSignup.textContent = "Please enter your full name.";
        return;
      }
      if (!email) {
        authMessageSignup.textContent = "Please enter your email.";
        return;
      }
      if (password.length < 6) {
        authMessageSignup.textContent = "Password must be at least 6 characters.";
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Send verification email
        await sendEmailVerification(user);

        // Save display name and placeholder profile pic
        await setDoc(doc(db, "users", user.uid), {
          name: name,
          email: email,
          profilePic: "",  // Will be updated later
          createdAt: serverTimestamp()
        });

        authMessageSignup.style.color = "green";
        authMessageSignup.textContent = "Account created! Please verify your email before logging in.";
      } catch (error) {
        authMessageSignup.textContent = error.message;
      }
    };

    // Login user
    document.getElementById("login-btn").onclick = async () => {
      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value.trim();
      authMessage.style.color = "red";

      if (!email || !password) {
        authMessage.textContent = "Please fill in all fields.";
        return;
      }

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        if (!user.emailVerified) {
          authMessage.textContent = "Please verify your email before logging in.";
          await signOut(auth);
          return;
        }
        // If profile incomplete, show profile setup else show app
      } catch (error) {
        authMessage.textContent = error.message;
      }
    };

    // Logout user
    logoutBtn.onclick = () => {
      signOut(auth);
    };

    // Auth state listener
    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        // Load user profile data
        const docSnap = await getDoc(doc(db, "users", user.uid));
        if (docSnap.exists()) {
          currentUserData = docSnap.data();

          if (!currentUserData.name || currentUserData.name.trim() === "" || !currentUserData.profilePic) {
            // Show profile setup if name or profile pic missing
            profileSetup.style.display = "block";
            authSection.style.display = "none";
            mainApp.style.display = "none";
          } else {
            // Show main app UI
            profileSetup.style.display = "none";
            authSection.style.display = "none";
            mainApp.style.display = "block";

            // Update UI with user info
            userNameDisplay.textContent = currentUserData.name;
            userProfilePic.src = currentUserData.profilePic || "https://via.placeholder.com/50?text=User";

            // Load posts
            loadPosts();

            // Clear search results on login
            userSearchResults.innerHTML = "";
          }
        } else {
          // If no user doc, show profile setup
          profileSetup.style.display = "block";
          authSection.style.display = "none";
          mainApp.style.display = "none";
        }
      } else {
        // User logged out
        currentUser = null;
        currentUserData = null;
        authSection.style.display = "block";
        profileSetup.style.display = "none";
        mainApp.style.display = "none";
        clearInputs();
        postsFeed.innerHTML = "";
        userSearchResults.innerHTML = "";
      }
    });

    // Save profile setup
    saveProfileBtn.onclick = async () => {
      const displayName = profileNameInput.value.trim();
      const file = profilePicInput.files[0];

      profileMsg.style.color = "red";
      if (!displayName) {
        profileMsg.textContent = "Please enter a display name.";
        return;
      }
      if (!file) {
        profileMsg.textContent = "Please upload a profile picture.";
        return;
      }

      try {
        profileMsg.textContent = "Uploading profile picture...";
        // Upload profile pic to storage
        const storageRef = ref(storage, `profile_pics/${currentUser.uid}_${Date.now()}`);
        await uploadBytes(storageRef, file);
        const photoURL = await getDownloadURL(storageRef);

        // Update user profile in auth and Firestore
        await updateProfile(currentUser, { displayName, photoURL });
        await updateDoc(doc(db, "users", currentUser.uid), {
          name: displayName,
          profilePic: photoURL
        });

        profileMsg.style.color = "green";
        profileMsg.textContent = "Profile updated! Loading app...";

        // Show main app
        profileSetup.style.display = "none";
        mainApp.style.display = "block";

        // Update UI
        userNameDisplay.textContent = displayName;
        userProfilePic.src = photoURL;

        loadPosts();
      } catch (err) {
        profileMsg.textContent = err.message;
      }
    };

    // Post media inputs change handlers
    postImageInput.onchange = (e) => {
      currentPostMediaFile = e.target.files[0];
      if (currentPostMediaFile) {
        mediaPreview.innerHTML = "";
        const img = document.createElement("img");
        img.src = URL.createObjectURL(currentPostMediaFile);
        mediaPreview.appendChild(img);
        // Clear video input
        postVideoInput.value = "";
      }
    };

    postVideoInput.onchange = (e) => {
      currentPostMediaFile = e.target.files[0];
      if (currentPostMediaFile) {
        mediaPreview.innerHTML = "";
        const video = document.createElement("video");
        video.src = URL.createObjectURL(currentPostMediaFile);
        video.controls = true;
        mediaPreview.appendChild(video);
        // Clear image input
        postImageInput.value = "";
      }
    };

    // Submit post
    submitPostBtn.onclick = async () => {
      const text = postText.value.trim();
      if (!text && !currentPostMediaFile) {
        alert("Post must have text or media!");
        return;
      }

      submitPostBtn.disabled = true;
      submitPostBtn.textContent = "Posting...";

      try {
        let mediaURL = "";
        let mediaType = "";

        if (currentPostMediaFile) {
          const ext = currentPostMediaFile.name.split('.').pop().toLowerCase();
          mediaType = currentPostMediaFile.type.startsWith("image") ? "image" : "video";

          const storageRef = ref(storage, `posts_media/${currentUser.uid}_${Date.now()}_${currentPostMediaFile.name}`);
          await uploadBytes(storageRef, currentPostMediaFile);
          mediaURL = await getDownloadURL(storageRef);
        }

        await addDoc(collection(db, "posts"), {
          uid: currentUser.uid,
          name: currentUserData.name,
          profilePic: currentUserData.profilePic || "",
          text: text,
          mediaURL: mediaURL,
          mediaType: mediaType,
          likes: [],
          createdAt: serverTimestamp(),
          comments: []
        });

        // Reset post creator
        postText.value = "";
        postImageInput.value = "";
        postVideoInput.value = "";
        mediaPreview.innerHTML = "";
        currentPostMediaFile = null;

        submitPostBtn.disabled = false;
        submitPostBtn.textContent = "Post";
      } catch (err) {
        alert("Error posting: " + err.message);
        submitPostBtn.disabled = false;
        submitPostBtn.textContent = "Post";
      }
    };

    // Load posts & listen for realtime updates
    function loadPosts() {
      const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
      onSnapshot(q, snapshot => {
        postsFeed.innerHTML = "";

        snapshot.forEach(docSnap => {
          const post = docSnap.data();
          post.id = docSnap.id;

          postsFeed.appendChild(createPostElement(post));
        });
      });
    }

    // Create post DOM element
    function createPostElement(post) {
      const postDiv = document.createElement("div");
      postDiv.className = "post";

      // Post header
      const header = document.createElement("div");
      header.className = "post-header";

      const profileImg = document.createElement("img");
      profileImg.src = post.profilePic || "https://via.placeholder.com/45?text=User";
      profileImg.alt = post.name;

      const usernameSpan = document.createElement("span");
      usernameSpan.className = "username";
      usernameSpan.textContent = post.name;

      header.appendChild(profileImg);
      header.appendChild(usernameSpan);
      postDiv.appendChild(header);

      // Post content text
      const content = document.createElement("div");
      content.className = "post-content";
      content.textContent = post.text || "";
      postDiv.appendChild(content);

      // Post media (image/video)
      if (post.mediaURL) {
        const mediaDiv = document.createElement("div");
        mediaDiv.className = "post-media";
        if (post.mediaType === "image") {
          const img = document.createElement("img");
          img.src = post.mediaURL;
          mediaDiv.appendChild(img);
        } else if (post.mediaType === "video") {
          const video = document.createElement("video");
          video.src = post.mediaURL;
          video.controls = true;
          mediaDiv.appendChild(video);
        }
        postDiv.appendChild(mediaDiv);
      }

      // Actions: Like, Comment, Share
      const actionsDiv = document.createElement("div");
      actionsDiv.className = "post-actions";

      // Like
      const likeSpan = document.createElement("span");
      likeSpan.innerHTML = `üëç <span>${post.likes.length || 0}</span>`;
      if (post.likes.includes(currentUser.uid)) {
        likeSpan.classList.add("liked");
      }
      likeSpan.onclick = () => toggleLike(post);
      actionsDiv.appendChild(likeSpan);

      // Comment
      const commentSpan = document.createElement("span");
      commentSpan.textContent = "üí¨ Comment";
      commentSpan.onclick = () => toggleComments(postDiv, post);
      actionsDiv.appendChild(commentSpan);

      // Share (just alert for demo)
      const shareSpan = document.createElement("span");
      shareSpan.textContent = "üîÑ Share";
      shareSpan.onclick = () => alert("Sharing feature coming soon!");
      actionsDiv.appendChild(shareSpan);

      postDiv.appendChild(actionsDiv);

      // Comments container (hidden initially)
      const commentsDiv = document.createElement("div");
      commentsDiv.className = "comments";
      commentsDiv.style.display = "none";
      postDiv.appendChild(commentsDiv);

      return postDiv;
    }

    // Like / unlike post
    async function toggleLike(post) {
      const postRef = doc(db, "posts", post.id);
      const liked = post.likes.includes(currentUser.uid);

      try {
        if (liked) {
          // Unlike
          const newLikes = post.likes.filter(uid => uid !== currentUser.uid);
          await updateDoc(postRef, { likes: newLikes });
        } else {
          // Like
          await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
        }
      } catch (err) {
        alert("Error updating like: " + err.message);
      }
    }

    // Toggle comments visibility + load comments
    function toggleComments(postDiv, post) {
      const commentsDiv = postDiv.querySelector(".comments");

      if (commentsDiv.style.display === "none") {
        commentsDiv.style.display = "block";
        renderComments(commentsDiv, post);
      } else {
        commentsDiv.style.display = "none";
        commentsDiv.innerHTML = "";
      }
    }

    // Render comments UI
    function renderComments(container, post) {
      container.innerHTML = "";

      // Comments list
      if (post.comments && post.comments.length > 0) {
        post.comments.forEach(c => {
          const cDiv = document.createElement("div");
          cDiv.className = "comment";

          const cImg = document.createElement("img");
          cImg.src = c.profilePic || "https://via.placeholder.com/30?text=U";
          cImg.alt = c.name;

          const cContent = document.createElement("div");
          cContent.className = "comment-content";

          const cName = document.createElement("div");
          cName.className = "comment-username";
          cName.textContent = c.name;

          const cText = document.createElement("div");
          cText.textContent = c.text;

          cContent.appendChild(cName);
          cContent.appendChild(cText);

          cDiv.appendChild(cImg);
          cDiv.appendChild(cContent);

          container.appendChild(cDiv);
        });
      }

      // Add comment form
      const form = document.createElement("form");
      form.className = "comment-form";

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Write a comment...";
      input.className = "comment-input";
      input.required = true;

      const submitBtn = document.createElement("button");
      submitBtn.type = "submit";
      submitBtn.className = "comment-submit-btn";
      submitBtn.textContent = "Send";

      form.appendChild(input);
      form.appendChild(submitBtn);
      container.appendChild(form);

      // Submit comment handler
      form.onsubmit = async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        try {
          const postRef = doc(db, "posts", post.id);
          const newComment = {
            uid: currentUser.uid,
            name: currentUserData.name,
            profilePic: currentUserData.profilePic || "",
            text: text,
            createdAt: new Date()
          };

          await updateDoc(postRef, { comments: arrayUnion(newComment) });
          input.value = "";
          // Refresh comments
          const updatedDoc = await getDoc(postRef);
          renderComments(container, updatedDoc.data());
        } catch (err) {
          alert("Error posting comment: " + err.message);
        }
      };
    }

    // Clear inputs on logout
    function clearInputs() {
      document.getElementById("login-email").value = "";
      document.getElementById("login-password").value = "";
      document.getElementById("signup-name").value = "";
      document.getElementById("signup-email").value = "";
      document.getElementById("signup-password").value = "";
      profileNameInput.value = "";
      profilePicInput.value = "";
      postText.value = "";
      postImageInput.value = "";
      postVideoInput.value = "";
      mediaPreview.innerHTML = "";
    }

    // User search functionality
    searchInput.oninput = async () => {
      const term = searchInput.value.trim().toLowerCase();
      userSearchResults.innerHTML = "";
      if (!term) return;

      try {
        // Query users where name contains term (simple client side filtering)
        const q = query(collection(db, "users"));
        const querySnapshot = await getDocs(q);
        const matchedUsers = [];

        querySnapshot.forEach(docSnap => {
          const user = docSnap.data();
          if (user.name.toLowerCase().includes(term)) {
            matchedUsers.push({ id: docSnap.id, ...user });
          }
        });

        if (matchedUsers.length === 0) {
          userSearchResults.innerHTML = "<p>No users found</p>";
        } else {
          matchedUsers.forEach(user => {
            const div = document.createElement("div");
            div.className = "search-user";

            const img = document.createElement("img");
            img.src = user.profilePic || "https://via.placeholder.com/35?text=U";
            img.alt = user.name;

            const span = document.createElement("span");
            span.textContent = user.name;

            div.appendChild(img);
            div.appendChild(span);

            userSearchResults.appendChild(div);
          });
        }
      } catch (err) {
        userSearchResults.innerHTML = "<p>Error searching users</p>";
      }
    };

  </script>
</body>
</html>
