<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pa Mwera - Social Network</title>
  <style>
    /* Simple modern colorful style */
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0; padding: 0;
      background: linear-gradient(135deg, #ff5252, #ff4081);
      color: #333;
    }
    header {
      background: #c70000;
      color: #fff;
      padding: 1rem;
      font-size: 1.8rem;
      font-weight: bold;
      text-align: center;
      letter-spacing: 1px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    main {
      max-width: 900px;
      margin: 2rem auto;
      background: #fff;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .hidden { display: none; }
    input, textarea {
      width: 100%;
      padding: 0.7rem;
      margin: 0.5rem 0 1rem 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      background: #c70000;
      color: white;
      border: none;
      padding: 0.8rem 1rem;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #a50000;
    }
    #posts {
      margin-top: 2rem;
    }
    .post {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #fafafa;
    }
    .post-header {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .profile-pic {
      width: 50px; height: 50px;
      border-radius: 50%;
      background: #ddd;
      object-fit: cover;
    }
    .post-content img, .post-content video {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 1rem;
    }
    .actions {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
    }
    .action-btn {
      cursor: pointer;
      color: #c70000;
      font-weight: bold;
    }
    #searchInput {
      margin-bottom: 1rem;
      padding: 0.5rem;
      font-size: 1rem;
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

  <header>ðŸ”¥ Pa Mwera</header>

  <main>
    <!-- Auth Section -->
    <div id="authSection">
      <div id="signupDiv">
        <h2>Sign Up</h2>
        <input id="signupName" type="text" placeholder="Full Name" />
        <input id="signupEmail" type="email" placeholder="Email" />
        <input id="signupPassword" type="password" placeholder="Password (6+ chars)" />
        <button id="signupBtn">Sign Up</button>
        <p>Already have an account? <a href="#" id="showLoginLink">Log In</a></p>
        <p id="signupMessage" style="color:red;"></p>
      </div>
      <div id="loginDiv" class="hidden">
        <h2>Log In</h2>
        <input id="loginEmail" type="email" placeholder="Email" />
        <input id="loginPassword" type="password" placeholder="Password" />
        <button id="loginBtn">Log In</button>
        <p>Don't have an account? <a href="#" id="showSignupLink">Sign Up</a></p>
        <p id="loginMessage" style="color:red;"></p>
      </div>
    </div>

    <!-- Main App Section -->
    <div id="appSection" class="hidden">
      <p>Welcome, <span id="userName"></span>! <button id="logoutBtn">Logout</button></p>

      <input id="searchInput" placeholder="Search users..." />

      <h3>Create a Post</h3>
      <textarea id="postText" placeholder="What's on your mind?" rows="3"></textarea>
      <input type="file" id="postMedia" accept="image/*,video/*" />
      <button id="postBtn">Post</button>
      <p id="postMessage" style="color:red;"></p>

      <h3>Posts</h3>
      <div id="posts"></div>
    </div>
  </main>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      updateProfile
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      setDoc,
      getDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp,
      onSnapshot,
      updateDoc,
      arrayUnion,
      arrayRemove,
      where
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC92g51j4qHlLgvf1GBHJfR58BlJ5rg7JQ",
      authDomain: "pa-mwera-social.firebaseapp.com",
      projectId: "pa-mwera-social",
      storageBucket: "pa-mwera-social.appspot.com",
      messagingSenderId: "255473977095",
      appId: "1:255473977095:web:ef6afedb928070f60027a2"
    };

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM elements
    const authSection = document.getElementById("authSection");
    const signupDiv = document.getElementById("signupDiv");
    const loginDiv = document.getElementById("loginDiv");
    const showLoginLink = document.getElementById("showLoginLink");
    const showSignupLink = document.getElementById("showSignupLink");
    const signupBtn = document.getElementById("signupBtn");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const signupMessage = document.getElementById("signupMessage");
    const loginMessage = document.getElementById("loginMessage");
    const userNameSpan = document.getElementById("userName");
    const appSection = document.getElementById("appSection");
    const postBtn = document.getElementById("postBtn");
    const postText = document.getElementById("postText");
    const postMedia = document.getElementById("postMedia");
    const postMessage = document.getElementById("postMessage");
    const postsDiv = document.getElementById("posts");
    const searchInput = document.getElementById("searchInput");

    // Show login/signup toggle
    showLoginLink.addEventListener("click", e => {
      e.preventDefault();
      signupDiv.classList.add("hidden");
      loginDiv.classList.remove("hidden");
      signupMessage.textContent = "";
      loginMessage.textContent = "";
    });
    showSignupLink.addEventListener("click", e => {
      e.preventDefault();
      loginDiv.classList.add("hidden");
      signupDiv.classList.remove("hidden");
      signupMessage.textContent = "";
      loginMessage.textContent = "";
    });

    // Signup handler (no email verification)
    signupBtn.addEventListener("click", async () => {
      const name = document.getElementById("signupName").value.trim();
      const email = document.getElementById("signupEmail").value.trim();
      const password = document.getElementById("signupPassword").value.trim();

      signupMessage.style.color = "red";
      if (!name) {
        signupMessage.textContent = "Please enter your full name.";
        return;
      }
      if (!email) {
        signupMessage.textContent = "Please enter your email.";
        return;
      }
      if (password.length < 6) {
        signupMessage.textContent = "Password must be at least 6 characters.";
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Update display name in Firebase Auth profile
        await updateProfile(user, { displayName: name });

        // Save user details in Firestore
        await setDoc(doc(db, "users", user.uid), {
          name: name,
          email: email,
          profilePic: "",
          createdAt: serverTimestamp()
        });

        signupMessage.style.color = "green";
        signupMessage.textContent = "Account created! You can now log in.";
      } catch (error) {
        signupMessage.textContent = error.message;
      }
    });

    // Login handler (no email verification check)
    loginBtn.addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      loginMessage.style.color = "red";

      if (!email || !password) {
        loginMessage.textContent = "Please fill in all fields.";
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
        // Success message removed here, UI will update onAuthStateChanged
      } catch (error) {
        loginMessage.textContent = error.message;
      }
    });

    // Logout handler
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // Listen for auth state changes
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        authSection.classList.add("hidden");
        appSection.classList.remove("hidden");

        // Get user details from Firestore
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
          userNameSpan.textContent = userDoc.data().name || user.email;
        } else {
          userNameSpan.textContent = user.email;
        }

        loadPosts();
      } else {
        authSection.classList.remove("hidden");
        appSection.classList.add("hidden");
        signupMessage.textContent = "";
        loginMessage.textContent = "";
        postMessage.textContent = "";
        postsDiv.innerHTML = "";
        userNameSpan.textContent = "";
      }
    });

    // Post creation
    postBtn.addEventListener("click", async () => {
      postMessage.style.color = "red";
      const text = postText.value.trim();
      const mediaFile = postMedia.files[0];
      if (!text && !mediaFile) {
        postMessage.textContent = "Please add text or media to post.";
        return;
      }

      postBtn.disabled = true;
      postMessage.textContent = "Posting...";

      let mediaURL = "";
      let mediaType = "";

      try {
        if (mediaFile) {
          const mediaRef = ref(storage, `posts/${auth.currentUser.uid}/${Date.now()}_${mediaFile.name}`);
          await uploadBytes(mediaRef, mediaFile);
          mediaURL = await getDownloadURL(mediaRef);
          mediaType = mediaFile.type.startsWith("video") ? "video" : "image";
        }

        // Create post doc
        await addDoc(collection(db, "posts"), {
          userId: auth.currentUser.uid,
          userName: userNameSpan.textContent,
          text: text,
          mediaURL: mediaURL,
          mediaType: mediaType,
          likes: [],
          comments: [],
          createdAt: serverTimestamp()
        });

        postMessage.style.color = "green";
        postMessage.textContent = "Post created!";
        postText.value = "";
        postMedia.value = "";
      } catch (error) {
        postMessage.textContent = "Error posting: " + error.message;
      }

      postBtn.disabled = false;
    });

    // Load and display posts
    function loadPosts() {
      const postsQuery = query(collection(db, "posts"), orderBy("createdAt", "desc"));
      onSnapshot(postsQuery, (snapshot) => {
        postsDiv.innerHTML = "";
        snapshot.forEach(docSnap => {
          const post = docSnap.data();
          const postId = docSnap.id;
          const isLiked = post.likes.includes(auth.currentUser.uid);

          // Create post container
          const postDiv = document.createElement("div");
          postDiv.classList.add("post");

          // Post header
          const headerDiv = document.createElement("div");
          headerDiv.classList.add("post-header");

          // Profile pic placeholder (no upload in this demo)
          const profilePic = document.createElement("div");
          profilePic.classList.add("profile-pic");
          profilePic.textContent = post.userName.charAt(0).toUpperCase();

          const nameSpan = document.createElement("span");
          nameSpan.textContent = post.userName;

          headerDiv.appendChild(profilePic);
          headerDiv.appendChild(nameSpan);
          postDiv.appendChild(headerDiv);

          // Post text content
          const textDiv = document.createElement("div");
          textDiv.classList.add("post-content");
          textDiv.textContent = post.text;
          postDiv.appendChild(textDiv);

          // Media if any
          if (post.mediaURL) {
            if (post.mediaType === "image") {
              const img = document.createElement("img");
              img.src = post.mediaURL;
              img.alt = "Post image";
              postDiv.appendChild(img);
            } else if (post.mediaType === "video") {
              const video = document.createElement("video");
              video.src = post.mediaURL;
              video.controls = true;
              postDiv.appendChild(video);
            }
          }

          // Actions: Like, Comment, Share
          const actionsDiv = document.createElement("div");
          actionsDiv.classList.add("actions");

          // Like button
          const likeBtn = document.createElement("span");
          likeBtn.classList.add("action-btn");
          likeBtn.textContent = isLiked ? `â¤ï¸ Unlike (${post.likes.length})` : `ðŸ¤ Like (${post.likes.length})`;
          likeBtn.onclick = async () => {
            const postRef = doc(db, "posts", postId);
            if (isLiked) {
              await updateDoc(postRef, {
                likes: arrayRemove(auth.currentUser.uid)
              });
            } else {
              await updateDoc(postRef, {
                likes: arrayUnion(auth.currentUser.uid)
              });
            }
          };
          actionsDiv.appendChild(likeBtn);

          // Comment button and UI
          const commentBtn = document.createElement("span");
          commentBtn.classList.add("action-btn");
          commentBtn.textContent = `ðŸ’¬ Comment (${post.comments.length})`;
          actionsDiv.appendChild(commentBtn);

          postDiv.appendChild(actionsDiv);

          // Comment section (hidden by default)
          const commentSection = document.createElement("div");
          commentSection.style.marginTop = "1rem";
          commentSection.style.display = "none";

          // Comments list
          const commentsList = document.createElement("div");
          post.comments.forEach(cmt => {
            const cmtDiv = document.createElement("div");
            cmtDiv.textContent = `${cmt.name}: ${cmt.text}`;
            commentsList.appendChild(cmtDiv);
          });
          commentSection.appendChild(commentsList);

          // Add comment input and button
          const commentInput = document.createElement("input");
          commentInput.placeholder = "Add a comment...";
          commentInput.style.marginTop = "0.5rem";

          const commentAddBtn = document.createElement("button");
          commentAddBtn.textContent = "Post Comment";

          commentAddBtn.onclick = async () => {
            const cText = commentInput.value.trim();
            if (!cText) return;
            const postRef = doc(db, "posts", postId);
            await updateDoc(postRef, {
              comments: arrayUnion({
                uid: auth.currentUser.uid,
                name: userNameSpan.textContent,
                text: cText,
                createdAt: serverTimestamp()
              })
            });
            commentInput.value = "";
          };

          commentSection.appendChild(commentInput);
          commentSection.appendChild(commentAddBtn);

          postDiv.appendChild(commentSection);

          commentBtn.onclick = () => {
            commentSection.style.display = commentSection.style.display === "none" ? "block" : "none";
          };

          postsDiv.appendChild(postDiv);
        });
      });
    }

    // User search (by name)
    searchInput.addEventListener("input", async () => {
      const searchTerm = searchInput.value.trim().toLowerCase();
      if (!searchTerm) {
        loadPosts();
        return;
      }
      // Search users by name
      const usersRef = collection(db, "users");
      const q = query(usersRef, where("name", ">=", searchTerm), where("name", "<=", searchTerm + "\uf8ff"));
      const querySnapshot = await getDocs(q);
      const userIds = querySnapshot.docs.map(doc => doc.id);

      // Filter posts to only those from matching users
      const postsQuery = query(collection(db, "posts"), orderBy("createdAt", "desc"));
      onSnapshot(postsQuery, (snapshot) => {
        postsDiv.innerHTML = "";
        snapshot.forEach(docSnap => {
          const post = docSnap.data();
          if (userIds.includes(post.userId)) {
            const postId = docSnap.id;
            const isLiked = post.likes.includes(auth.currentUser.uid);

            // Create post container
            const postDiv = document.createElement("div");
            postDiv.classList.add("post");

            // Post header
            const headerDiv = document.createElement("div");
            headerDiv.classList.add("post-header");

            // Profile pic placeholder (no upload in this demo)
            const profilePic = document.createElement("div");
            profilePic.classList.add("profile-pic");
            profilePic.textContent = post.userName.charAt(0).toUpperCase();

            const nameSpan = document.createElement("span");
            nameSpan.textContent = post.userName;

            headerDiv.appendChild(profilePic);
            headerDiv.appendChild(nameSpan);
            postDiv.appendChild(headerDiv);

            // Post text content
            const textDiv = document.createElement("div");
            textDiv.classList.add("post-content");
            textDiv.textContent = post.text;
            postDiv.appendChild(textDiv);

            // Media if any
            if (post.mediaURL) {
              if (post.mediaType === "image") {
                const img = document.createElement("img");
                img.src = post.mediaURL;
                img.alt = "Post image";
                postDiv.appendChild(img);
              } else if (post.mediaType === "video") {
                const video = document.createElement("video");
                video.src = post.mediaURL;
                video.controls = true;
                postDiv.appendChild(video);
              }
            }

            // Actions: Like, Comment, Share
            const actionsDiv = document.createElement("div");
            actionsDiv.classList.add("actions");

            // Like button
            const likeBtn = document.createElement("span");
            likeBtn.classList.add("action-btn");
            likeBtn.textContent = isLiked ? `â¤ï¸ Unlike (${post.likes.length})` : `ðŸ¤ Like (${post.likes.length})`;
            likeBtn.onclick = async () => {
              const postRef = doc(db, "posts", postId);
              if (isLiked) {
                await updateDoc(postRef, {
                  likes: arrayRemove(auth.currentUser.uid)
                });
              } else {
                await updateDoc(postRef, {
                  likes: arrayUnion(auth.currentUser.uid)
                });
              }
            };
            actionsDiv.appendChild(likeBtn);

            // Comment button and UI
            const commentBtn = document.createElement("span");
            commentBtn.classList.add("action-btn");
            commentBtn.textContent = `ðŸ’¬ Comment (${post.comments.length})`;
            actionsDiv.appendChild(commentBtn);

            postDiv.appendChild(actionsDiv);

            // Comment section (hidden by default)
            const commentSection = document.createElement("div");
            commentSection.style.marginTop = "1rem";
            commentSection.style.display = "none";

            // Comments list
            const commentsList = document.createElement("div");
            post.comments.forEach(cmt => {
              const cmtDiv = document.createElement("div");
              cmtDiv.textContent = `${cmt.name}: ${cmt.text}`;
              commentsList.appendChild(cmtDiv);
            });
            commentSection.appendChild(commentsList);

            // Add comment input and button
            const commentInput = document.createElement("input");
            commentInput.placeholder = "Add a comment...";
            commentInput.style.marginTop = "0.5rem";

            const commentAddBtn = document.createElement("button");
            commentAddBtn.textContent = "Post Comment";

            commentAddBtn.onclick = async () => {
              const cText = commentInput.value.trim();
              if (!cText) return;
              const postRef = doc(db, "posts", postId);
              await updateDoc(postRef, {
                comments: arrayUnion({
                  uid: auth.currentUser.uid,
                  name: userNameSpan.textContent,
                  text: cText,
                  createdAt: serverTimestamp()
                })
              });
              commentInput.value = "";
            };

            commentSection.appendChild(commentInput);
            commentSection.appendChild(commentAddBtn);

            postDiv.appendChild(commentSection);

            commentBtn.onclick = () => {
              commentSection.style.display = commentSection.style.display === "none" ? "block" : "none";
            };

            postsDiv.appendChild(postDiv);
          }
        });
      });
    });

  </script>

</body>
</html>
